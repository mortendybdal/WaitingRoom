"use strict";angular.module("waitingRoomApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAnimate","ngAnimate-animate.css","xeditable","ngClipboard","slick","restangular","ui.tree","ui.bootstrap","angular-loading-bar"]).config(["$routeProvider","$locationProvider","$httpProvider","cfpLoadingBarProvider",function(a,b,c,d){a.when("/",{templateUrl:"partials/frontpage",controller:"FrontpageCtrl",resolve:{loggedin:["Auth",function(a){return a.isLoggedIn()}]}}).when("/patient/:step/:id",{templateUrl:"partials/patient",controller:"PatientCtrl",resolve:{loggedin:["Auth",function(a){return a.isLoggedIn()}]}}).when("/builder/scheme/:id",{templateUrl:"partials/builder/scheme-builder",controller:"SchemeBuilderCtrl",resolve:{loggedin:["Auth",function(a){return a.isLoggedIn()}]}}).when("/builder/step/:id",{templateUrl:"partials/builder/step-builder",controller:"StepBuilderCtrl",resolve:{loggedin:["Auth",function(a){return a.isLoggedIn()}]}}).when("/builder/question/:id",{templateUrl:"partials/builder/question-builder",controller:"QuestionBuilderCtrl",resolve:{loggedin:["Auth",function(a){return a.isLoggedIn()}]}}).when("/customers",{templateUrl:"partials/customers/clinics",controller:"ClinicsCtrl",resolve:{loggedin:["Auth",function(a){return a.isLoggedIn()}]}}).when("/customer/clinic/:id",{templateUrl:"partials/customers/doctors",controller:"DoctorsCtrl",resolve:{loggedin:["Auth",function(a){return a.isLoggedIn()}]}}).when("/tablet",{templateUrl:"partials/tablet",controller:"TabletCtrl"}).when("/settings",{templateUrl:"partials/settings",controller:"SettingsCtrl",resolve:{loggedin:["Auth",function(a){return a.isLoggedIn()}]}}).when("/login",{templateUrl:"partials/login",controller:"LoginCtrl"}).when("/signup",{templateUrl:"partials/signup",controller:"SignupCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0),d.includeSpinner=!1,c.interceptors.push(["$q","$location",function(a,b){return{responseError:function(c){return 401===c.status?(b.path("/login"),a.reject(c)):a.reject(c)}}}])}]).run(["$rootScope","$location","Auth","Restangular",function(a,b,c,d){d.setBaseUrl("api"),a.$on("$routeChangeStart",function(d,e){a.$broadcast("event:load_start"),e.authenticate&&!c.isLoggedIn()&&b.path("/login")})}]),angular.module("waitingRoomApp").controller("MainCtrl",["$scope","$rootScope","$timeout",function(a,b,c){b.$on("event:load_start",function(){a.is_loading_content=!0}),b.$on("event:load_stop",function(){c(function(){a.is_loading_content=!1},300)})}]),angular.module("waitingRoomApp").controller("FrontpageCtrl",["$scope","$rootScope","$interval","Restangular",function(a,b,c,d){a.basePatients=d.all("patients"),a.basePatients.getList().then(function(c){a.patients=c,b.$broadcast("event:load_stop")}),a.calcTimeSinceSubmition=function(a){return window.moment(a).fromNow()},a.formatDateTime=function(a){return window.moment(a).format("HH:mm")}}]),angular.module("waitingRoomApp").controller("PatientCtrl",["$scope","$rootScope","$routeParams","$timeout","Restangular",function(a,b,c,d,e){function f(){c.id&&e.one("patients",c.id).get().then(function(c){c&&(a.patient=c,e.one("schemes",a.patient.Schemes[0]._id).one("patient",a.patient._id).get().then(function(c){console.log(c),a.questions=c,a.steps=_.sortBy(_.uniq(_.map(a.questions,"Step"),"Title"),"SortOrder"),a.setQuestions(a.steps[0]),h(),b.$broadcast("event:load_stop")}))})}function g(b){return _.sortBy(_.filter(a.questions,function(a){return a.Step._id===b._id}),"SortOrder")}function h(){var b="";_.forEach(a.steps,function(a){var c=g(a);_.forEach(c,function(a){a.JournalText&&a.Answer&&(b+=a.JournalText.replace("{{}}",a.Answer)+", ")}),b+="\n\n"}),a.journal_text=b}a.is_copying_jounal=!1,a.is_loading_soap_widget=!1,a.baseAnswers=e.all("answers"),a.setQuestions=function(b){a.is_loading_soap_widget=!0,a.current_step=b,a.soap_item_list=g(b),d(function(){a.is_loading_soap_widget=!1},600)},a.saveAnswer=function(b){if(b){var c={AnswerText:b.Answer,Question_id:b._id,Patient_id:a.patient._id};a.baseAnswers.post(c),h()}},a.copyPast=function(){return a.journal_text},a.copyPastEffect=function(){a.is_copying_jounal=!0,d(function(){a.is_copying_jounal=!1},300)},a.backStep=function(){var b=_.find(a.steps,{SortOrder:a.current_step.SortOrder-1});b&&a.setQuestions(b)},a.nextStep=function(){var b=_.find(a.steps,{SortOrder:a.current_step.SortOrder+1});b&&a.setQuestions(b)},f()}]),angular.module("waitingRoomApp").controller("TabletCtrl",["$scope","$rootScope","$timeout","Restangular",function(a,b,c,d){function e(){var b=[],c=0;_.forEach(a.questions,function(b){if(console.log("Clean out procedure",b),b&&b.ParentQuestion){var c=_.find(a.questions,function(a){return a._id===b.ParentQuestion});c.Answer&&c.Answer!==b.CorrectAnswer.Value&&_.remove(a.questions,function(a){return a._id===b._id})}}),_.forEach(_.sortBy(a.questions,"SortOrder"),function(d){d.SortOrder=c,c++,b.push(d),_.forEach(_.sortBy(d.questions,"SortOrder"),function(e){e.CorrectAnswer&&d.Answer&&d.Answer===e.CorrectAnswer.Value&&d._id!==e._id&&(_.find(a.questions,function(a){return a._id===e._id})||(e.SortOrder=c,c++,b.push(e)))})}),a.questions=b}b.hide_navigation_menu=!0,a.index=-1,a.direction="left",a.scheme_type="none",a.baseSchemes=d.all("schemes"),a.basePatients=d.all("patients"),a.baseAnswers=d.all("answers"),a.baseSchemes.getList().then(function(d){a.schemes=d,c(function(){b.$broadcast("event:load_stop")})}),a.nextSlide=function(b){if(b){e();var d={AnswerText:b.Answer,Question_id:b._id,Patient_id:a.patient._id};a.baseAnswers.post(d).then(function(){console.log("Object saved OK")},function(){console.log("There was an error saving")})}c(function(){a.index++,a.direction="left"},0)},a.backSlide=function(){a.index--,a.direction="right"},a.finishQuestionary=function(){a.nextSlide()},a.createPatient=function(b){a.questions=_.find(b.steps,{Title:"Subjective"}).questions,a.nextSlide(),a.basePatients.post().then(function(c){a.patient=c,c.Schemes.push(b._id),c.save()})},a.getNumberOfSlidesShown=function(a){return a.length<4?a.length:3}}]),angular.module("waitingRoomApp").controller("LoginCtrl",["$scope","$rootScope","Auth","$location",function(a,b,c,d){b.$broadcast("event:load_stop"),a.user={},a.errors={},a.login=function(b){a.submitted=!0,b.$valid&&c.login({email:a.user.email,password:a.user.password}).then(function(){d.path("/")}).catch(function(b){b=b.data,a.errors.other=b.message})},a.onKeyPressed=function(b,c){13===c.keyCode&&a.login(b)}}]),angular.module("waitingRoomApp").controller("SignupCtrl",["$scope","$rootScope","Auth","$location",function(a,b,c,d){b.$broadcast("event:load_stop"),a.user={},a.errors={},a.register=function(b){a.submitted=!0,b.$valid&&c.createUser({name:a.user.name,email:a.user.email,password:a.user.password}).then(function(){d.path("/")}).catch(function(c){c=c.data,a.errors={},angular.forEach(c.errors,function(c,d){b[d].$setValidity("mongoose",!1),a.errors[d]=c.message})})}}]),angular.module("waitingRoomApp").controller("NavigationCtrl",["$scope","$rootScope","$location","$modal","$timeout","Auth","Restangular",function(a,b,c,d,e,f,g){a.baseSchemes=g.all("schemes"),a.expanded_items=[],a.baseSchemes.getList().then(function(b){a.schemes=b}),a.logout=function(){console.log("Logout?"),f.logout().then(function(){c.path("/login")})},a.showContentTree=function(){a.show_content_tree=!a.show_content_tree},a.hideContentTree=function(){console.log("Hide"),a.show_content_tree=!1},a.expandContentTree=function(b){_.contains(a.expanded_items,b._id)?_.remove(a.expanded_items,function(a){return a===b._id}):a.expanded_items.push(b._id)},a.contentItemIsOpen=function(b){return _.contains(a.expanded_items,b._id)},b.$on("event:update_content_tree",function(){a.baseSchemes.getList().then(function(b){a.schemes=b,console.log("Updating content....")})}),a.$on("$routeChangeStart",function(){a.show_content_tree=!1}),a.content_tree={accept:function(a,b){return a.depth()===b.depth()+1&&b.isParent(a)},dropped:function(a){var b=a.dest.nodesScope,c=b.$element.attr("data-type"),d=b.$modelValue;_.forEach(d,function(a,b){g.one(c,a._id).get().then(function(a){a.SortOrder=b,a.save()})})}},a.openModal=function(a,b){console.log(name),d.open({templateUrl:"partials/modals/create-modal.html",controller:["$scope","$modalInstance","ModalService",function(c,d,e){c.ModalService=e.init(d),c.type=a,c.parent_id=b}]})},a.openDeleteModal=function(a,b,c){d.open({templateUrl:"partials/modals/delete-modal.html",controller:["$scope","$modalInstance","ModalService",function(d,e,f){d.ModalService=f.init(e),d.type=a,d.name=b,d.item_id=c}]})}}]),angular.module("waitingRoomApp").controller("SettingsCtrl",["$scope","$rootScope","User","Auth",function(a,b,c,d){b.$broadcast("event:load_stop"),a.errors={},a.changePassword=function(b){a.submitted=!0,b.$valid&&d.changePassword(a.user.oldPassword,a.user.newPassword).then(function(){a.message="Password successfully changed."}).catch(function(){b.password.$setValidity("mongoose",!1),a.errors.other="Incorrect password"})}}]),angular.module("waitingRoomApp").controller("SchemeBuilderCtrl",["$scope","$rootScope","$routeParams","$modal","$location","Restangular",function(a,b,c,d,e,f){c.id&&f.one("schemes",c.id).get().then(function(c){a.scheme=c,b.$broadcast("event:load_stop")}),a.save=function(c){a.submitted=!0,c.$valid&&(a.updating_scheme=!0,a.scheme.save().then(function(){a.updating_scheme=!1,b.$broadcast("event:update_content_tree")}))},a.openModal=function(a,b){d.open({templateUrl:"partials/modals/create-modal.html",controller:["$scope","$modalInstance","ModalService",function(c,d,e){c.ModalService=e.init(d),c.type=a,c.parent_id=b}]})}}]),angular.module("waitingRoomApp").controller("StepBuilderCtrl",["$scope","$rootScope","$routeParams","$modal","$location","Restangular",function(a,b,c,d,e,f){c.id&&f.one("steps",c.id).get().then(function(c){a.step=c,b.$broadcast("event:load_stop")}),a.save=function(c){a.submitted=!0,c.$valid&&(a.updating_step=!0,a.step.save().then(function(){a.updating_step=!1,b.$broadcast("event:update_content_tree")}))},a.openModal=function(a,b){d.open({templateUrl:"partials/modals/create-modal.html",controller:["$scope","$modalInstance","ModalService",function(c,d,e){c.ModalService=e.init(d),c.type=a,c.parent_id=b}]})}}]),angular.module("waitingRoomApp").controller("QuestionBuilderCtrl",["$scope","$rootScope","$routeParams","$modal","$location","Restangular",function(a,b,c,d,e,f){function g(){var b,c;b="......"===a.journal_prefix||"&#8203"===a.journal_prefix?"":a.journal_prefix,c="......"===a.journal_suffix||"&#8203"===a.journal_suffix?"":a.journal_suffix;var d=b+" {{}} "+c;return d.replace(/&nbsp;/g,"")}function h(b){if(b){var c=b.split("{{}}");console.log(c[0]),a.journal_prefix=c[0]?c[0]:"......",console.log(c[1]),a.journal_suffix=c[1]?c[1]:"......"}}a.options=[{Label:"Single Text",Value:"single-text"},{Label:"Multi Text",Value:"multi-text"},{Label:"Radio List",Value:"radio-list"},{Label:"Select List",Value:"select-list"}],a.journal_prefix="......",a.journal_suffix="......",c.id&&f.one("questions",c.id).get().then(function(c){a.question=c,a.question.Type=_.find(a.options,a.question.Type),a.question.ParentQuestion&&a.question.ParentQuestion.Options&&a.question.CorrectAnswer&&(a.question.CorrectAnswer=_.find(a.question.ParentQuestion.Options,a.question.CorrectAnswer)),h(a.question.JournalText),b.$broadcast("event:load_stop")}),a.save=function(c){a.submitted=!0,console.log(c),c.$valid&&(a.updating_question=!0,_.remove(a.question.Options,function(a){return""===a.Value&&""===a.Key}),a.question.JournalText=g(),a.question.save().then(function(){a.updating_question=!1,b.$broadcast("event:update_content_tree")}))},a.openModal=function(a,b){d.open({templateUrl:"partials/modals/create-modal.html",controller:["$scope","$modalInstance","ModalService",function(c,d,e){c.ModalService=e.init(d),c.type=a,c.parent_id=b}]})},a.addOption=function(){var b={Key:"",Value:""};a.question.Options.push(b)},a.prefixFocus=function(){"......"===a.journal_prefix&&(a.journal_prefix="&#8203")},a.prefixBlur=function(){("&#8203"===a.journal_prefix||""===a.journal_prefix)&&(a.journal_prefix="......")},a.suffixFocus=function(){"......"===a.journal_suffix&&(a.journal_suffix="&#8203")},a.suffixBlur=function(){("&#8203"===a.journal_suffix||""===a.journal_suffix)&&(a.journal_suffix="......")}}]),angular.module("waitingRoomApp").controller("ClinicsCtrl",["$scope","$rootScope","$modal","Restangular",function(a,b,c,d){function e(){a.baseClinics.getList().then(function(c){a.clinics=c,b.$broadcast("event:load_stop")})}a.baseClinics=d.all("clinics"),a.clinics=[],a.openModal=function(){c.open({templateUrl:"partials/modals/create-clinic-modal.html",controller:["$scope","$modalInstance","clinics",function(a,b,c){console.log(a),a.save=function(e,f){a.is_submitted=!0,e.$valid&&(a.is_loading=!0,d.all("clinics").post(f).then(function(d){a.is_loading=!1,a.is_submitted=!1,c.push(d),b.close()},function(){console.log("Error occured when creating new customer")}))},a.close=function(){b.close()}}],resolve:{clinics:function(){return a.clinics}}})},e()}]),angular.module("waitingRoomApp").controller("DoctorsCtrl",["$scope","$rootScope","$routeParams","$modal","Restangular",function(a,b,c,d,e){function f(){c.id&&(e.one("clinics",c.id).get().then(function(c){a.clinic=c,console.log(a.clinic),b.$broadcast("event:load_stop")}),e.one("users",c.id).get().then(function(b){a.users=b,console.log(a.users)}))}a.roles=[{Label:"Admin",Value:0},{Label:"Editor",Value:1},{Label:"User",Value:2}],a.openModal=function(){d.open({templateUrl:"partials/modals/create-doctor-modal.html",controller:["$scope","$modalInstance","users","roles",function(a,b,d,f){a.roles=f,a.save=function(f,g){a.is_submitted=!0,console.log(f),f.$valid&&(a.is_loading=!0,g.clinic=c.id,e.all("users").post(g).then(function(c){a.is_loading=!1,a.is_submitted=!1,d.push(c),b.close()},function(){console.log("Error occured when creating new customer")}))},a.close=function(){b.close()}}],resolve:{users:function(){return a.users},roles:function(){return a.roles}}})},f()}]),angular.module("waitingRoomApp").directive("offClick",["$document",function(a){function b(a,b){if(!a||!b)return!1;for(var c=angular.element(b),d=c.length,e=0;d>e;++e)if(c[e].contains(a))return!0;return!1}return{restrict:"A",scope:{offClick:"&",offClickIf:"&"},link:function(c,d,e){function f(a){var f=a.target||a.srcElement;d[0].contains(f)||b(f,e.offClickFilter)||c.$apply(c.offClick())}e.offClickIf?c.$watch(c.offClickIf,function(b,c){b&&!c?a.on("click",f):b||a.off("click",f)}):a.on("click",f)}}}]),angular.module("waitingRoomApp").directive("contenteditable",["$timeout",function(a){return{restrict:"A",require:"?ngModel",link:function(b,c,d,e){if(e){var f={};angular.forEach(["stripBr","noLineBreaks","selectNonEditable","moveCaretToEndOnChange"],function(a){var b=d[a];f[a]=b&&"false"!==b}),c.bind("input",function(){b.$apply(function(){var b,d,g;b=c.html(),g=!1,f.stripBr&&(b=b.replace(/<br>$/,"")),f.noLineBreaks&&(d=b.replace(/<div>/g,"").replace(/<br>/g,"").replace(/<\/div>/g,""),d!==b&&(g=!0,b=d)),e.$setViewValue(b),g&&e.$render(),""===b&&a(function(){c[0].blur(),c[0].focus()})})});var g=e.$render;e.$render=function(){var a,b,d,h;g&&g(),c.html(e.$viewValue||""),f.moveCaretToEndOnChange&&(a=c[0],d=document.createRange(),h=window.getSelection(),a.childNodes.length>0?(b=a.childNodes[a.childNodes.length-1],d.setStartAfter(b)):d.setStartAfter(a),d.collapse(!0),h.removeAllRanges(),h.addRange(d))},f.selectNonEditable&&c.bind("click",function(a){var b,c,d;d=a.toElement,d!==this&&"false"===angular.element(d).attr("contenteditable")&&(b=document.createRange(),c=window.getSelection(),b.setStartBefore(d),b.setEndAfter(d),c.removeAllRanges(),c.addRange(b))})}}}}]),angular.module("waitingRoomApp").factory("ModalService",["$rootScope","$timeout","$location","Restangular",function(a,b,c,d){function e(b){console.log("SCHEME func",b);var e={};e.Title=b,d.all("schemes").post(e).then(function(b){l.is_loading=!1,l.is_submitted=!1,l.modal_instance.close(),a.$broadcast("event:update_content_tree"),c.path("builder/scheme/"+b._id)},function(){console.log("Error occured when creating new scheme")})}function f(b,e){var f={};f.Title=b,f.Scheme_id=e,d.all("steps").post(f).then(function(b){console.log(b),l.is_loading=!1,l.is_submitted=!1,l.modal_instance.close(),a.$broadcast("event:update_content_tree"),c.path("builder/step/"+b._id)},function(){console.log("Error occured when creating new scheme")})}function g(b,e){var f={};f.QuestionText=b,f.Step=e,d.all("questions").post(f).then(function(b){console.log(b),l.is_loading=!1,l.is_submitted=!1,l.modal_instance.close(),a.$broadcast("event:update_content_tree"),c.path("builder/question/"+b._id)},function(){console.log("Error occured when creating new scheme")})}function h(b,e){var f={};f.QuestionText=b,f.ParentQuestion=e,d.all("questions").post(f).then(function(b){console.log(b),l.is_loading=!1,l.is_submitted=!1,l.modal_instance.close(),a.$broadcast("event:update_content_tree"),c.path("builder/question/"+b._id)},function(){console.log("Error occured when creating new scheme")})}function i(b){console.log("deleteScheme func",b),d.one("Schemes",b).remove().then(function(){l.is_loading=!1,l.is_submitted=!1,l.modal_instance.close(),a.$broadcast("event:update_content_tree")})}function j(b){console.log("deleteStep func",b),d.one("Steps",b).remove().then(function(){l.is_loading=!1,l.is_submitted=!1,l.modal_instance.close(),a.$broadcast("event:update_content_tree")})}function k(b){console.log("deleteQuestion func - NOT IMPLEMENTED",b),d.one("Questions",b).remove().then(function(){l.is_loading=!1,l.is_submitted=!1,l.modal_instance.close(),a.$broadcast("event:update_content_tree")})}var l=this;return l.is_loading=!1,l.is_submitted=!1,l.modal_instance={},{init:function(a){return l.modal_instance=a,this},isLoading:function(){return l.is_loading},isSubmitted:function(){return l.is_submitted},save:function(a,b,c,d){if(!l.modal_instance)throw"Service has not been iniziated with a modal scope";if(l.is_submitted=!0,console.log("The modal service -- save function was called",a,b,parent),a.$valid)switch(l.is_loading=!0,b){case"Scheme":e(d);break;case"Step":f(d,c);break;case"Question":g(d,c);break;case"Subquestion":h(d,c);break;default:throw"The content type "+b+"is not recoqnized."}},"delete":function(a,b){if(!l.modal_instance)throw"Service has not been iniziated with a modal scope";switch(l.is_submitted=!0,l.is_loading=!0,a){case"Scheme":i(b);break;case"Step":j(b);break;case"Question":k(b);break;default:throw"The content type "+a+"is not recoqnized."}},close:function(){l.modal_instance.close()}}}]),angular.module("waitingRoomApp").factory("Auth",["$location","$rootScope","$cookieStore","$http","$timeout","$q","Session","User",function(a,b,c,d,e,f,g,h){return b.currentUser=c.get("user")||null,c.remove("user"),{login:function(a,c){var d=c||angular.noop;return g.save({email:a.email,password:a.password},function(a){return b.currentUser=a,d()},function(a){return d(a)}).$promise},logout:function(a){var c=a||angular.noop;return g.delete(function(){return b.currentUser=null,b.is_logged_in=!1,c()},function(a){return c(a)}).$promise},createUser:function(a,c){var d=c||angular.noop;return h.save(a,function(a){return b.currentUser=a,d(a)},function(a){return d(a)}).$promise},changePassword:function(a,b,c){var d=c||angular.noop;return h.update({oldPassword:a,newPassword:b},function(a){return d(a)},function(a){return d(a)}).$promise},currentUser:function(){return h.get()},isLoggedIn:function(){var c=b.currentUser;return c?b.is_logged_in=!0:(b.is_logged_in=!1,a.url("/login")),!!c}}}]),angular.module("waitingRoomApp").factory("Session",["$resource",function(a){return a("/api/session/")}]),angular.module("waitingRoomApp").factory("User",["$resource",function(a){return a("/api/users/:id",{id:"@id"},{update:{method:"PUT",params:{}},get:{method:"GET",params:{id:"me"}}})}]),angular.module("waitingRoomApp").directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){b.on("keydown",function(){return d.$setValidity("mongoose",!0)})}}});